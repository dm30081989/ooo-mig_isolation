# osmapi.py

**ЗАВИСИМОСТИ**: `pandas`, `numpy`, `overpy`, `Point`, `LineString`, `Polygon`, `MultiPolygon` (from `shapely.geometry`)

Модуль содержит функции для взаимодействия с OpenStreepMap Overpass API. Взаимодействие происходит через библиотеку `overpy`, поэтому перед запсуком её необходимо установить (если это не было сделано раннее). 

Установить на Windows (CMD):
```
py -m pip install overpy
```

Установить на Unix/macOs:
```
pip install overpy
```

Логически модуль можно разбить на четыре части: 
1) Функции, обрабатывающие элементы OSM: relation, way, node
2) Функции, составляющие запросы для разных категорий тегов на языке Overpass API
3) Функции, формирующие базы данных для соответствующих категорий тегов
4) Функции для выбора объектов, например, из пилотной зоны.

## Функции, обрабатывающие элементы OSM

Включает в себя 4 важные основные функции (начинаются с `extract_`) и 1 важную вспомогательную (`arrange_nodes`), которая необходима для правильного построения relation. Используется в `extract_relations_data_from_OSM`.

### - `extract_nodes_data_from_OSM(result)`
Позволяет обрабатывать узлы (node), используя Overpass API. Тип геометрии - точка (point). 

**Параметры:** 
- *result* - объект класса overpy.Overpass

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полную информацию обо всех node согласно соответствующему запросу (о запросах - дальше).   

### - `extract_ways_data_from_OSM(result)`
Позволяет обрабатывать пути (way), используя Overpass API. Тип геометрии - линия (linestring). Создает список узлов для каждого пути. Нужна для выгрузки дорог.

**Параметры:** 
- *result* - объект класса overpy.Overpass

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полную информацию обо всех way согласно соответствующему запросу. 

### - `extract_polygons_data_from_OSM(result)`
Позволяет обрабатывать замкнутные пути (way), используя Overpass API. Тип геометрии - линия (linestring) или многоугольник (polygon) в зависимости от количества точек в нем. Создает список узлов для каждого пути.

**Параметры:** 
- *result* - объект класса overpy.Overpass

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полную информацию обо всех замкнутых way согласно соответствующему запросу.   

### - `extract_relations_data_from_OSM(result)`
Позволяет обрабатывать отношения (relation), используя Overpass API. Тип геометрии - суперпозиция многоугольников (multypolygon). Создает список узлов для каждого пути в отоншении, обьединяет в один список и сортирует их на основании пересечения путей при помощи `extract_relations_data_from_OSM`.

**Параметры:** 
- *result* - объект класса overpy.Overpass

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полную информацию обо всех relation согласно соответствующему запросу.  

## Функции, составляющие запросы

Имеют название `get_*_[way/relation]_query`. Формируют запросы для URL, которые впоследствии передаются объекту класса overpy.Overpass. Используется уникальный язык Overpass API. 

Запросы для поиска объектов в некоторой окружности, центр окружности и радиус задается через параметры. Используется ключевое слово `around` (подробнее - <https://github.com/drolbr/Overpass-API/blob/master/src/overpass_api/statements/around.cc>)

**Параметры:**
- *latitude* - географическая широта в десятичных градусах
- *longitude* - географическая долгота в десятичных градусах
- *radius* - радиус в метрах
- *tag* - тег, **только** для дорог

**Возвращает:** строку-запрос на Overpass API Language

## Функции, формирующие базы данных

Имеют название "*_table". Используют функции с предыдущих блоков и создают pandas.DataFrame, удобный для работы с данными. Поиск в больших радиусах может занимать много времени и памяти. 

### - `road_table(latitude: float = 55.75222, longitude: float = 37.61556, big_radius: float = 2000, small_radius: float = 1000)`

**Cтолбцы:**
- `element_type` - way
- `highway` - тип дороги, согласно OSM
- `geometry` - linestring с координатами 
- `name` - название дороги
- `maxspeed` - максимальная скорость
- `lanes` - количество полос
-`ref` - второе название, если есть
- `pue` - ранг, согласно ПУЭ
- `rank` - оценка загруженности дороги

**Параметры:**
- *latitude* - географическая широта в десятичных градусах
- *longitude* - географическая долгота в десятичных градусах
- *big_radius* - радиус в метрах (для больших трасс/шоссе)
- *small_radius* - радиус в метрах (для городских дорог)

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полезную информацию обо всех дорогах в заданных радиусах.   

### - `industrial_table(latitude: float = 55.75222, longitude: float = 37.61556, radius: float = 5000)`

**Cтолбцы:**
- `element_type` - linestring, polygon или multypolygon
- `type` - тип тега, согласно OSM
- `geometry` - element_type c координатами здания
- `name` - название промышленного здания
- `pue` - ранг, согласно ПУЭ
- `production_volume` - объем производства, задается вручную
- `product` - объем производства, задается вручную
- `lat` - центроид, широта
- `lon` - центроид, долгота

**Параметры:**
- *latitude* - географическая широта в десятичных градусах
- *longitude* - географическая долгота в десятичных градусах
- *radius* - радиус в метрах 

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полезную информацию обо всех промышленных зданиях в заданных радиусах.   

Возможные значения `product`:
- `chemistry` - химические предприятия и производства
- `cellulose` - производство целлюлозы
- `paper` - производство бумаги
- `cast_iron` - выплавка чугуна и стали
- `mount` - горнообогатительные комбинаты
- `coke_chemical` - коксохимпроизводство
- `aluminum` - производство алюминия
- `rera_metal` - производство редких металлов
- `color_metal` - производство и обработка цветных металлов
- `cement` - производство цемента
- `asbestos` - производство абсеста и др.
- `concrete` - производство бетонных изделий и др.
- `car` - машиностроительное предприятие или производство
- `iron_mining` - добыча железной руды
- `coal_mining` - добыча угля
- `boiler_slate` - ТЭС и котельные на сланцах (нужна высота трубы)
- `boiler_сoal` - ТЭС и котельные на углях (нужна высота трубы)
- `tbo` - отвалы пылящих материалов, складских зданий и сооружений, кнализационно-очистных сооружений
- `road` - автодорога с интенсивным использованием в зимнее время химических средств

### Описанное выше справедливо для `nature_table` (поля, леса), `quarry_table` (карьеры), `tbo` (свалки) за исключением колонок `product`, `production_volume`.

### - `chimney_table(latitude: float = 55.75222, longitude: float = 37.61556, radius: float = 5000)`

**Cтолбцы:**
- `point_type` - тип источника (нужен для дополнения БД, пока что 'chimney')
- `geometry` - polygon c координатами здания
- `height` - высота трубы, если известна
- `power` - мощность трубы в процентах, ручной ввод. Позволяет сегментрировать промышленные здания, на которых располагается
- `lat` - центроид, широта
- `lon` - центроид, долгота

**Параметры:**
- *latitude* - географическая широта в десятичных градусах
- *longitude* - географическая долгота в десятичных градусах
- *radius* - радиус в метрах 

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полезную информацию обо всех промышленных трубах в заданных радиусах.   

### - `city_table(latitude: float = 55.75222, longitude: float = 37.61556, radius: float = 5000)`

Не являются источниками загрязнения. Городская застройка (жилые дома, торговые центры, офисы). 

**Cтолбцы:**
- `element_type` - linestring, polygon или multypolygon
- `type` - тип тега, согласно OSM
- `geometry` - element_type c координатами здания
- `name` - название здания
- `building:levels` - количество этажей в здании
- `height` - высота здания, если известна
- `lat` - центроид, широта
- `lon` - центроид, долгота

**Параметры:**
- *latitude* - географическая широта в десятичных градусах
- *longitude* - географическая долгота в десятичных градусах
- *radius* - радиус в метрах. В пределах МКАДа не рекомендуется использовать `radius` > 1000.

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полезную информацию обо всех жилых и общественных помещениях в заданных радиусах.   

## Функции для выбора объектов

Фильтруют/приводят к удобному виду уже имеющиеся базы.

### - `choose_roads(data: pd.DataFrame)`

Выбирает дороги из пилотной зоны. Игнорирует городские дороги.

**Параметры:**
- *data* - база данных, полученная при помощи функции `road_table`

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полезную информацию о дорогах в пилотной зоне. 

### - `choose_industrial(data: pd.DataFrame)`

Выбирает промышленные зоны из пилотной зоны. Проработана не до конца.

**Параметры:**
- *data* - база данных, полученная при помощи функции `choose_source`

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полезную информацию о промышленных зонах в пилотной зоне.

### - `choose_source(latitude: float, longitude: float, distance: float = 5000)`

Позволяет одним функциональным вызовом собрать большую базу данных об источниках загрязнения. 

**Параметры:**
- *latitude* - географическая широта в десятичных градусах
- *longitude* - географическая долгота в десятичных градусах
- *radius* - радиус в метрах

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полезную информацию обо всех источниках загрязнения сразу.

# distancer.py

**ЗАВИСИМОСТИ**: `math`, `Point`, `LineString`, `Polygon` (from `shapely.geometry`)

Модуль, содежращий в себе методы поиска расстояний.

### - `nearest2point(lat1: float, lon1: float, lat2: float, lon2: float)`

Ищет расстояние от точки до точки в метрах. Точки задаются координатами. 

**Параметры:**
- *lat1* - координата географической широты первой точки 
- *lon1* - координата географической долготы первой точки
- *lat2* - координата географической широты второй точки 
- *lon2* - координата географической долготы второй точки

**Возвращает:**
Значение типа `float` - расстояние между двумя точками в метрах.

### - `nearest2line(lat: float, lon: float, line: LineString)`

Ищет расстояние от точки для отрезка, который задается одним объектом типа `LineString`. Линия должна находиться не дальше, чем за 5 км от точки. Сперва происходит распаковка точек линии. Каждый последующий участок аппроксимируется двумя соседними точками. Начинается обход по участку с шагом, приблизительно, в 10 метров. Выбирается минимальное расстояние и соответствующая координата.  

**Параметры:**
- *lat* - координата географической широты
- *lon* - координата географической долготы
- *line* - линия, задается в виде `LineString`

**Возвращает:**
- *min_dist* - минимальное расстояние от точки до линии
- *min_coord* - координата точки на линии, в которой достигается минимальное расстояние (в некоторых случаеях - проекция), `Point`

### - `nearest2road(lat: float, lon: float, road)`

Ищет расстоянии от точки до дороги, которая может состоять из серии объектов типа `LineString`. Более универсальная, чем предыдущая.

**Параметры:**
- *lat* - координата географической широты
- *lon* - координата географической долготы
- *road* - дорога, `LineString`/`MultiLineString`/`list`/любой итерируемый объект

**Возвращает:**
- *min_dist* - минимальное расстояние от точки до дороги
- *min_coord* - координата точки на дороге, в которой достигается минимальное расстояние (в некоторых случаеях - проекция), `Point`

### - `nearest2polygon(lat: float, lon: float, building: Polygon)`

Ищет расстояние от точки до здания. В качестве точки на здании берется его центр масс. Подробнее о том, как ищется центр масс - <>

**Параметры:**
- *lat* - координата географической широты
- *lon* - координата географической долготы
- *building* - здание, задается в виде `Polygon` или `MultiPolygon`

**Возвращает:**
Значение типа `float` - расстояние от точки до здания в метрах.

### - `add_distance2polygon(lat: float, lon: float, data)`

Метод, позволяющий добавлять столбец `distance` к таблице с источниками. На основании предудыщих функций вычисляет расстояние и записывает в соответсвующую строку в базе данных. Используется только для объектов, которые можно представить в виде замкнутой линии (или их последовательности). Исходная база меняется.

**Параметры:**
- *lat* - координата географической широты
- *lon* - координата географической долготы
- *data* - объект типа `pandas.DataFrame`

### - `add_distance2road(lat: float, lon: float, data)`

Метод, позволяющий добавлять столбец 'distance' к таблице с источниками. На основании предудыщих функций вычисляет расстояние и записывает в соответсвующую строку в базе данных. Используется только для дорог. Исходная база меняется.

**Параметры:**
- *lat* - координата географической широты
- *lon* - координата географической долготы
- *data* - объект типа `pandas.DataFrame`

# scorer.py

**ЗАВИСИМОСТИ**: `pandas`, `distancer`

Cостоит из двух логических блоков: блок, в котором хронятся таблицы из ПУЭ, и блок с функциями, присвивающими источникам загрязнения ранг согласно соответствующим таблицам. Содержит метод для оценки загруженности дороги внутри МКАДа.

### - `add_pue_industrial(lat: float, lon: float, industrials: pd.DataFrame)`

В зависимости от значения в колонке `product` подбирает таблицу из ПУЭ (с помощью словаря) и вызывает подходящий метод для оценки. Основывается на расстоянии до источника и объемах производства. Модифицирует исходную таблицу, добавляя значение в колонку `pue`. Есть аналогичная функция для дорог, `add_pue_roads`.

**Параметры:**
- *lat* - координата географической широты опоры
- *lon* - координата географической долготы опоры
- *industrials* - объект типа `pandas.DataFrame` с данными о промышленных ИЗ

### - `road_score(data: pd.DataFrame, month: int)`

Присваивает коэффициент загруженности участка дороги на основании исследований Яндекс. Учитывается расстояние дороги от центра и месяц, в который данные должны быть использованы. Модифицирует исходную таблицу, добавляя значение в колонку `rank`.

**Параметры:**
- *data* - объект типа pandas.DataFrame c информацией о дорогах
- *month* - месяц проведения исследования

# improver.py

**ЗАВИСИМОСТИ**: `pandas`, `distancer`, `numpy`, `math`, `Point`, `LineString`, `Polygon`, `MultiPolygon`, `MultiLineString` (from `shapely.geometry`)

Модуль содержит самые сложные функции, которые позволяют тем или иным образом характеризовать расположение источников загрязнений относительно некоторой точки, других источников, городской среды, ветров.

### - `clarify_location(buildings: pd.DataFrame, chimneys: pd.DataFrame)`

Функция принимает две таблицы и соединяет их в одну по факту вложения геометрии элемента chimneys в геометрию элемента buildings.

**Параметры:**
- *buildings* - объект типа pandas.DataFrame, информация о промышленных зданиях 
- *chimneys* - объект типа pandas.DataFrame, информация о трубах и других точках, полезных для сигментации

**Возвращает:**
- *sorted_buildings* - объект типа pandas.DataFrame. Таблица промышленных зданий с учетом сигментации
- *sorted_chimneys* - объект типа pandas.DataFrame. Таблица с точками, которые не были использованы при построении `sorted_buildings`

### - `calculate_production_volume(data: pd.DataFrame)`

Пересчитывает значения в столбце `production_volume` после выполнения функции `update_production_volume`. Адаптирует объемы производства под значение мощности `power` источника. Учитывает те источники, у которых мощность не задана - делит объем между точкам равномерно. Модифицирует исходную таблицу.

**Параметры:**
- *data* - объект типа pandas.DataFrame

### - `update_production_volume(data: pd.DataFrame, name: str, value: float)`

Позволяет корректировать значения объемов производства в соответствии с мощностью точек источника в случае, если общий объем производства для того или иного источника изменилась. Источник идентифиицируется при помощи его названия. Модифицирует исходную базу.

**Параметры:**
- *data* - объект типа pandas.DataFrame. Таблица с данными о промышленных зданиях. 
- *name* - название источника загрязнения
- *value* - обновленный объем производства

### - `road_accounting(data: pd.DataFrame, lat: float, lon: float, m1: float, m2: float, m3: float)`

Функция выбирает участки дорог, входящие в окружности/кольца радиусов `m1`, `m2`, `m3` и для каждого участка считает площадь, содержащуюся в окружности этого радиуса. Таким образом, в таблице появится две новые колонки и множество новых строк: 1) число, в какую окружность входит участок дороги - `circle`; 2) площадь входящего участка - `area`. Окружности нумеруются в порядке отдаления от заданной точки. Не меняет текущую таблицу.

**Параметры:**
- *data* - объект типа pandas.DataFrame. Таблица с информацией о дорогах.
- *lat* -  координата географической широты опоры
- *lon* -  координата географической долготы опоры
- *m1* - радиус наименьшей окружности в метрах
- *m2* - радиус средней окружности в метрах
- *m3* - радиус наибольшей окружности в метрах

**Возвращает:**
- *new_data* - объект типа pandas.DataFrame с новыми столбцами `circle` и `area`

### - `city_accounting(latitude: float, longitude: float, radius: float, data_city: pd.DataFrame, data_road: pd.DataFrame, data_industrial: pd.DataFrame)`



**Параметры:**


**Возвращает:**

### - `wind_accounting(latitude: float, longitude: float, data: pd.DataFrame, dict_wind_rose: dict)`



**Параметры:**


**Возвращает:**

# changer.py

**ЗАВИСИМОСТИ**: `pandas`, `numpy`, `Point`, `LineString`, `Polygon` (from `shapely.geometry`)

Содержит серию функций, позволяющих дополнять данные вручную.
