# osmapi.py

**ЗАВИСИМОСТИ**: `pandas`, `numpy`, `overpy`, `Point`, `LineString`, `Polygon`, `MultiPolygon` (from `shapely.geometry`)

Модуль содержит функции для взаимодействия с OpenStreepMap Overpass API. Взаимодействие происходит через библиотеку `overpy`, поэтому перед запсуком её необходимо установить (если это не было сделано раннее). 

Установить на Windows(CMD):
```
py -m pip install overpy
```

Установить на Unix/macOs:
```
pip install overpy
```

Логически модуль можно разбить на четыре части: 
1) Функции, обрабатывающие элементы OSM: relation, way, node
2) Функции, составляющие запросы для разных категорий тегов на языке Overpass API
3) Функции, формирующие базы данных для соответствующих категорий тегов
4) Функции для выбора объектов, например, из пилотной зоны.

## Функции, обрабатывающие элементы OSM

Включает в себя 4 важные основные функции (начинаются с `extract_`) и 1 важную вспомогательную (`arrange_nodes`), которая необходима для правильного построения relation. Используется в `extract_relations_data_from_OSM`.

### - `extract_nodes_data_from_OSM(result)`
Позволяет обрабатывать узлы (node), используя Overpass API. Тип геометрии - точка (point). 

**Параметры:** 
- *result* - объект класса overpy.Overpass

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полную информацию обо всех node согласно соответствующему запросу (о запросах - дальше).   

### - `extract_ways_data_from_OSM(result)`
Позволяет обрабатывать пути (way), используя Overpass API. Тип геометрии - линия (linestring). Создает список узлов для каждого пути. Нужна для выгрузки дорог.

**Параметры:** 
- *result* - объект класса overpy.Overpass

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полную информацию обо всех way согласно соответствующему запросу. 

### - `extract_polygons_data_from_OSM(result)`
Позволяет обрабатывать замкнутные пути (way), используя Overpass API. Тип геометрии - линия (linestring) или многоугольник (polygon) в зависимости от количества точек в нем. Создает список узлов для каждого пути.

**Параметры:** 
- *result* - объект класса overpy.Overpass

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полную информацию обо всех замкнутых way согласно соответствующему запросу.   

### - `extract_relations_data_from_OSM(result)`
Позволяет обрабатывать отношения (relation), используя Overpass API. Тип геометрии - суперпозиция многоугольников (multypolygon). Создает список узлов для каждого пути в отоншении, обьединяет в один список и сортирует их на основании пересечения путей при помощи `extract_relations_data_from_OSM`.

**Параметры:** 
- *result* - объект класса overpy.Overpass

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полную информацию обо всех relation согласно соответствующему запросу.  

## Функции, составляющие запросы

Имеют название `get_*_[way/relation]_query`. Формируют запросы для URL, которые впоследствии передаются объекту класса overpy.Overpass. Используется уникальный язык Overpass API. 

Запросы для поиска объектов в некоторой окружности, центр окружности и радиус задается через параметры. Используется ключевое слово `around` (подробнее - <https://github.com/drolbr/Overpass-API/blob/master/src/overpass_api/statements/around.cc>)

**Параметры:**
- *latitude* - географическая широта в десятичных градусах
- *longitude* - географическая долгота в десятичных градусах
- *radius* - радиус в метрах
- *tag* - тег, **только** для дорог

**Возвращает:** строку-запрос на Overpass API Language

## Функции, формирующие базы данных

Имеют название "*_table". Используют функции с предыдущих блоков и создают pandas.DataFrame, удобный для работы с данными. Поиск в больших радиусах может занимать много времени и памяти. 

### - `road_table(latitude: float = 55.75222, longitude: float = 37.61556, big_radius: float = 2000, small_radius: float = 1000)`

**Cтолбцы:**
- `element_type` - way
- `highway` - тип дороги, согласно OSM
- `geometry` - linestring с координатами 
- `name` - название дороги
- `maxspeed` - максимальная скорость
- `lanes` - количество полос
-`ref` - второе название, если есть
- `pue` - ранг, согласно ПУЭ
- `rank` - оценка загруженности дороги

**Параметры:**
- *latitude* - географическая широта в десятичных градусах
- *longitude* - географическая долгота в десятичных градусах
- *big_radius* - радиус в метрах (для больших трасс/шоссе)
- *small_radius* - радиус в метрах (для городских дорог)

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полезную информацию обо всех дорогах в заданных радиусах.   

### - `industrial_table(latitude: float = 55.75222, longitude: float = 37.61556, radius: float = 5000)`

**Cтолбцы:**
- `element_type` - linestring, polygon или multypolygon
- `type` - тип тега, согласно OSM
- `geometry` - element_type c координатами здания
- `name` - название промышленного здания
- `pue` - ранг, согласно ПУЭ
- `production_volume` - объем производства, задается вручную
- `product` - объем производства, задается вручную
- `lat` - центроид, широта
- `lon` - центроид, долгота

**Параметры:**
- *latitude* - географическая широта в десятичных градусах
- *longitude* - географическая долгота в десятичных градусах
- *radius* - радиус в метрах 

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полезную информацию обо всех промышленных зданиях в заданных радиусах.   

### Описанное выше справедливо для `nature_table` (поля, леса), `quarry_table` (карьеры), `tbo` (свалки) за исключением колонок `product`, `production_volume`.

### - `chimney_table(latitude: float = 55.75222, longitude: float = 37.61556, radius: float = 5000)`

**Cтолбцы:**
- `point_type` - тип источника (нужен для дополнения БД, пока что 'chimney')
- `geometry` - polygon c координатами здания
- `height` - высота трубы, если известна
- `power` - мощность трубы в процентах, ручной ввод. Позволяет сегментрировать промышленные здания, на которых располагается
- `lat` - центроид, широта
- `lon` - центроид, долгота

**Параметры:**
- *latitude* - географическая широта в десятичных градусах
- *longitude* - географическая долгота в десятичных градусах
- *radius* - радиус в метрах 

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полезную информацию обо всех промышленных трубах в заданных радиусах.   

### - `city_table(latitude: float = 55.75222, longitude: float = 37.61556, radius: float = 5000)`

Не являются источниками загрязнения. Городская застройка (жилые дома, торговые центры, офисы). 

**Cтолбцы:**
- `element_type` - linestring, polygon или multypolygon
- `type` - тип тега, согласно OSM
- `geometry` - element_type c координатами здания
- `name` - название здания
- 'building:levels' - количество этажей в здании
- `height` - высота здания, если известна
- `lat` - центроид, широта
- `lon` - центроид, долгота

**Параметры:**
- *latitude* - географическая широта в десятичных градусах
- *longitude* - географическая долгота в десятичных градусах
- *radius* - радиус в метрах. В пределах МКАДа не рекомендуется использовать `radius` > 1000.

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полезную информацию обо всех жилых и общественных помещениях в заданных радиусах.   

## Функции для выбора объектов

Фильтруют/приводят к удобному вижу уже имеющиеся базы.

### - `choose_roads(data: pd.DataFrame)`

Выбирает дороги из пилотной зоны. Игнорирует городские дороги.

**Параметры:**
- *data* - база данных, полученная при помощи функции `road_table`

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полезную информацию о дорогах в пилотной зоне. 

### - `choose_industrial(data: pd.DataFrame)`

Выбирает промышленные зоны из пилотной зоны. Проработана не до конца.

**Параметры:**
- *data* - база данных, полученная при помощи функции `choose_source`

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полезную информацию о промышленных зонах в пилотной зоне.

### - `choose_source(lat: float, lon: float, distance: float = 5000)`

Позволяет одним функциональным вызовом собрать большую базу данных об источниках загрязнения. 

**Параметры:**
- *latitude* - географическая широта в десятичных градусах
- *longitude* - географическая долгота в десятичных градусах
- *radius* - радиус в метрах

**Возвращает:**
Объект типа pandas.DataFrame, содержащий полезную информацию обо всех источниках загрязнения сразу.
